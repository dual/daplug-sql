version: 2.1
orbs:
    python: circleci/python@3.3.0
    sonarcloud: sonarsource/sonarcloud@3.0.1
commands:
    setup-artifacts:
        steps:
            - run: mkdir ./coverage && mkdir ./coverage/grpc && mkdir ./coverage/lint && mkdir ./coverage/reports && mkdir ./coverage/pretty && mkdir ./coverage/typing || exit 0
    run-tests:
        steps:
            - run: pipenv run test
            - run: pipenv run coverage
            - store_artifacts:
                  path: ./coverage
            - store_test_results:
                  path: ./coverage/reports/junit.xml
    pypi-setup:
        steps:
            - run: echo -e "[pypi]" >> ~/.pypirc
            - run: echo -e "username = __token__" >> ~/.pypirc
            - run: echo -e "password = $PYPI_TOKEN" >> ~/.pypirc
    pypi-publish:
        steps:
            - run: python3 -m pip install --user --upgrade setuptools wheel
            - run: python3 setup.py sdist bdist_wheel
            - run: python3 -m pip install --user --upgrade twine
            - run: python3 -m twine upload dist/*
    run-lint:
        steps:
            - run: pipenv run lint
            - run: pipenv run pylint daplug_sql --output-format=json > ./coverage/lint/pylint_report.json || exit 0
            - run: pipenv run pylint-json2html ./coverage/lint/pylint_report.json -o ./coverage/lint/pylint_report.html || exit 0
            - store_artifacts:
                  path: ./coverage/lint
    run-type-check:
        steps:
            - run: pipenv run type-check
    wait-for-databases:
        steps:
            - run:
                  name: Wait for database containers
                  command: |
                      for port in 5432 3306; do
                        for i in $(seq 1 30); do
                          if (echo > /dev/tcp/127.0.0.1/$port) >/dev/null 2>&1; then
                            break
                          fi
                          sleep 2
                        done
                      done
jobs:
    lint:
        docker:
            - image: cimg/python:3.9.17
        steps:
            - attach_workspace:
                  at: ~/project
            - setup-artifacts
            - run-lint
    typing:
        docker:
            - image: cimg/python:3.9.17
        steps:
            - attach_workspace:
                  at: ~/project
            - setup-artifacts
            - run-type-check
    test:
        docker:
            - image: cimg/python:3.9.17
            - image: postgres:15
              environment:
                  POSTGRES_USER: test
                  POSTGRES_PASSWORD: test
                  POSTGRES_DB: daplug
            - image: mysql:8.0
              command: --default-authentication-plugin=mysql_native_password --sql-mode=STRICT_TRANS_TABLES
              environment:
                  MYSQL_ROOT_PASSWORD: root
                  MYSQL_DATABASE: daplug
                  MYSQL_USER: test
                  MYSQL_PASSWORD: test
        steps:
            - attach_workspace:
                  at: ~/project
            - setup-artifacts
            - wait-for-databases
            - run:
                  name: Export DB host/port for tests
                  command: |
                      echo 'export SQL_POSTGRES_HOST=127.0.0.1' >> $BASH_ENV
                      echo 'export SQL_POSTGRES_PORT=5432' >> $BASH_ENV
                      echo 'export SQL_POSTGRES_USER=test' >> $BASH_ENV
                      echo 'export SQL_POSTGRES_PASSWORD=test' >> $BASH_ENV
                      echo 'export SQL_POSTGRES_DB=daplug' >> $BASH_ENV
                      echo 'export SQL_MYSQL_HOST=127.0.0.1' >> $BASH_ENV
                      echo 'export SQL_MYSQL_PORT=3306' >> $BASH_ENV
                      echo 'export SQL_MYSQL_USER=test' >> $BASH_ENV
                      echo 'export SQL_MYSQL_PASSWORD=test' >> $BASH_ENV
                      echo 'export SQL_MYSQL_DB=daplug' >> $BASH_ENV
            - run-tests
            - sonarcloud/scan
    install-build:
        docker:
            - image: cimg/python:3.9.17
        steps:
            - checkout:
                  method: full
            - python/install-packages:
                  pkg-manager: pipenv
                  args: "--dev"
            - persist_to_workspace:
                  root: ~/project
                  paths:
                      - ./*
    install-build-publish:
        docker:
            - image: cimg/python:3.9.17
        steps:
            - checkout:
                  method: full
            - python/install-packages:
                  pkg-manager: pipenv
            - pypi-setup
            - pypi-publish
workflows:
    install-build-publish-workflow:
        jobs:
            - install-build-publish:
                  context:
                      - pipenv
                  filters:
                      tags:
                          only: /.*/
                      branches:
                          ignore: /.*/
    install-build-test-workflow:
        jobs:
            - install-build:
                  context:
                      - pipenv
            - lint:
                  requires:
                      - install-build
            - test:
                  context:
                      - sonarcloud
                  requires:
                      - install-build
            - typing:
                  requires:
                      - install-build
